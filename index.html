<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PHRQL SMART App Client</title>

</head>
<body>


    <script type="text/javascript">
        this.patient = "";
        this.immunizations = "";
        this.allergies = "";
        this.patientVitals = "";
        getCookie("Russ");
        debugger;
        loginUserWitOauth(); //login to PHRQL
        // console.log(client);

        function getCookie(name) {
            // Split cookie string and get all individual name=value pairs in an array
            var cookieArr = document.cookie.split(";");
            console.log("cookieList", document.cookie);
            // Loop through the array elements
            for (var i = 0; i < cookieArr.length; i++) {
                var cookiePair = cookieArr[i].split("=");

                /* Removing whitespace at the beginning of the cookie name
                and compare it with the given string */
                if (name == cookiePair[0].trim()) {
                    // Decode the cookie value and return
                    console.log(decodeURIComponent(cookiePair[1]));
                    return decodeURIComponent(cookiePair[1]);
                }
            }

            // Return null if not found
            return null;
        }
        async function loginUserWitOauth() {
            var code = null;
            const queryString = window.location.search;
            console.log(queryString);
            const urlParams = new URLSearchParams(queryString);
            code = urlParams.get('code')
            //	let code=this.urlParams.get('code');
            var redirectURI = "https://smartfhir.phrqltest.com";
            var url = "https://accounts-phrqltest.auth.us-west-2.amazoncognito.com/oauth2/authorize?response_type=code&client_id=118a1qur3i4k7jpf4drf2nd7v7&redirect_uri=" + redirectURI + "&scope=openid";
            //let state = uuidv4();
            //console.log("state=" + state)
            //.log("this.redirectURI=" + this.redirectURI)

            console.log("code=", code)
            if (code == null) {
                // href = phrql_login_url;
                console.log("code1=", code)
                console.log("location=" + url);
                getCookie("Russ");
                debugger;

                await fetch(url, {
                    method: 'post',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => { console.log(response); })
            } else {
                appClientId = "118a1qur3i4k7jpf4drf2nd7v7"
                console.log("authorization code", code)
                var redirectURI = "https://smartfhir.phrqltest.com";
                var url = "https://accounts-phrqltest.auth.us-west-2.amazoncognito.com/oauth2/authorize?response_type=authorization_code&code=" + code + "&client_id=" + appClientId + "&redirect_uri=" + redirectURI + "&scope=openid";
          
                //await fetch(`/cors-proxy/${url}`, {
                    await fetch(url, {
                        method: 'post',
                        mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Origin': 'smartfhir.phrqltest.com',
                        'origin_service': 'https://smartfhir.phrqltest.com'
                    }
                })
                    .then((response) => { return response.json  } 
                     )
                    .then((data) => {
                        console.log("data",JSON.stringify(data));
                        this.tokens = data;
                        this.authService.accessToken = data.access_token;
                        this.authService.refreshToken = data.refresh_token;
                        //this.authService.getCurrentUserDetails().subscribe((profile:any) => {
                        //	console.log(profile);
                        //this.authService.username=profile.firstName+" " +profile.lastName;
                        //this.router.navigateByURL("/tabs");
                        //});
                    }) 
                    .catch ((error) => {
                            console.error('Error:', error);
                    });
            }//end else
        }
        domain = "accounts-phrqltest";
        region = "us-west-2";
        state = "";
        appClientId = "118a1qur3i4k7jpf4drf2nd7v7";
            //this.redirectURI = "https://priceless-mclean-588366.netlify.app/";



    </script>
</body>
</html>
